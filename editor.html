<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Ù…Ø­Ø±Ø± Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
*{box-sizing:border-box;margin:0;padding:0}

body{
  font-family:'Cairo',sans-serif;
  background:#f0f2f5;
  display:flex;
  min-height:100vh;
}

/* ===== SIDEBAR ===== */
.sidebar{
  width:420px;
  background:#fff;
  padding:30px;
  overflow-y:auto;
  height:100vh;
  box-shadow:2px 0 12px rgba(0,0,0,0.15);
  order:2;
}

.sidebar::-webkit-scrollbar{width:8px}
.sidebar::-webkit-scrollbar-track{background:#f1f1f1}
.sidebar::-webkit-scrollbar-thumb{background:#bbb;border-radius:4px}

.sidebar-header{
  font-size:1.4rem;
  font-weight:700;
  color:#0b2a4a;
  margin-bottom:30px;
  padding-bottom:15px;
  border-bottom:3px solid #0b2a4a;
}

.section{
  margin-bottom:30px;
  padding-bottom:20px;
  border-bottom:1px solid #eee;
}

.section:last-child{
  border-bottom:none;
}

.section-title{
  font-size:1.05rem;
  font-weight:700;
  color:#0b2a4a;
  margin-bottom:15px;
  background:#f8f9fa;
  padding:12px;
  border-radius:6px;
  border-right:4px solid #3498db;
}

.form-group{
  margin-bottom:15px;
}

.form-group label{
  display:block;
  font-weight:600;
  color:#333;
  margin-bottom:7px;
  font-size:0.95rem;
}

.form-group input{
  width:100%;
  padding:11px;
  border:2px solid #ddd;
  border-radius:6px;
  font-family:'Cairo',sans-serif;
  font-size:0.95rem;
  transition:all 0.3s;
}

.form-group input:focus{
  outline:none;
  border-color:#3498db;
  background:#fffacd;
  box-shadow:0 0 5px rgba(52,152,219,0.3);
}

.grade-row{
  display:grid;
  grid-template-columns:2fr 1fr 1fr;
  gap:10px;
  align-items:center;
  padding:12px;
  background:#f9f9f9;
  border-radius:6px;
  margin-bottom:10px;
  border-left:3px solid #3498db;
}

.grade-row label{
  font-weight:600;
  font-size:0.90rem;
  color:#0b2a4a;
  margin:0;
}

.grade-row input{
  width:100%;
  padding:8px;
  border:1px solid #ddd;
  text-align:center;
  margin:0;
  font-size:0.9rem;
}

.grade-row input:focus{
  border-color:#3498db;
  background:#fffacd;
}

.buttons-group{
  display:flex;
  gap:10px;
  margin-bottom:15px;
  flex-wrap:wrap;
}

.btn{
  flex:1;
  min-width:90px;
  padding:12px;
  border:none;
  border-radius:6px;
  font-weight:600;
  cursor:pointer;
  font-family:'Cairo',sans-serif;
  font-size:0.95rem;
  transition:all 0.3s;
}

.btn:active{
  transform:scale(0.98);
}

.btn-primary{
  background:#27ae60;
  color:#fff;
}
.btn-primary:hover{
  background:#229954;
  box-shadow:0 4px 12px rgba(39,174,96,0.4);
}

.btn-secondary{
  background:#3498db;
  color:#fff;
}
.btn-secondary:hover{
  background:#2980b9;
  box-shadow:0 4px 12px rgba(52,152,219,0.4);
}

.btn-pdf{
  background:#0b2a4a;
  color:#fff;
}
.btn-pdf:hover{
  background:#0a1f35;
}

.btn-png{
  background:#cc9900;
  color:#fff;
}
.btn-png:hover{
  background:#b38700;
}

.btn-lang{
  background:#9b59b6;
  color:#fff;
}
.btn-lang:hover{
  background:#8e44ad;
}

.message{
  padding:12px;
  border-radius:6px;
  margin-bottom:15px;
  font-weight:600;
  display:none;
}

.message.show{
  display:block;
  animation:slideDown 0.3s ease;
}

@keyframes slideDown{
  from{transform:translateY(-10px);opacity:0}
  to{transform:translateY(0);opacity:1}
}

.message.success{
  background:#d4edda;
  color:#155724;
  border:1px solid #c3e6cb;
}

.message.error{
  background:#f8d7da;
  color:#721c24;
  border:1px solid #f5c6cb;
}

.message.info{
  background:#d1ecf1;
  color:#0c5460;
  border:1px solid #bee5eb;
}

/* ===== MAIN CONTENT ===== */
.main-content{
  flex:1;
  padding:30px;
  order:1;
  overflow-y:auto;
  height:100vh;
}

.main-content::-webkit-scrollbar{width:8px}
.main-content::-webkit-scrollbar-track{background:#f1f1f1}
.main-content::-webkit-scrollbar-thumb{background:#bbb;border-radius:4px}

/* ===== Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© ===== */
.certificate{
  max-width:900px;
  position:relative;
  background:
    radial-gradient(circle at 15% 20%, rgba(255,200,150,0.45) 0 12%, transparent 12%),
    radial-gradient(circle at 85% 75%, rgba(150,200,255,0.45) 0 14%, transparent 14%),
    linear-gradient(135deg, #fff5e6 0%, #e6f7ff 100%);
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
  padding-bottom:40px;
  margin-bottom:30px;
}

.bubble{position:absolute;border-radius:50%;opacity:.85;filter:blur(.6px)}
.bubble.b1{width:120px;height:120px;left:20px;top:20px;background:radial-gradient(circle at 30% 30%, #ffd9a6, #ffb07a)}
.bubble.b2{width:90px;height:90px;right:30px;top:40px;background:radial-gradient(circle at 30% 30%, #cfe9ff, #8fc3ff)}

.header{
  text-align:center;
  padding:60px 20px 30px;
}

.header h1{
  font-size:2.2rem;
  color:#0b2a4a;
  margin-bottom:8px;
}

.header p{
  color:#333;
}

.content{
  padding:30px 60px;
}

.info-row{
  display:flex;
  gap:15px;
  margin:15px 0;
  font-size:1rem;
}

.label{
  font-weight:700;
  min-width:140px;
  color:#0b2a4a;
  flex-shrink:0;
}

.value{
  flex:1;
  border-bottom:2px dashed #333;
  padding:5px 8px;
  min-height:24px;
}

table{
  width:100%;
  margin:30px 0;
  border-collapse:collapse;
  background:rgba(255,255,255,.90);
}

th,td{
  border:1px solid #999;
  padding:12px 8px;
  text-align:center;
  font-size:0.95rem;
}

th{
  background:#0b2a4a;
  color:#fff;
  font-weight:700;
}

td.subject{
  text-align:right;
  font-weight:600;
}

.total-row td{
  font-weight:700;
  background:#eef3ff;
}

.result{
  text-align:center;
  font-size:1.5rem;
  font-weight:700;
  margin:25px 0;
  color:#0b2a4a;
}

.signature{
  position:relative;
  text-align:center;
  margin-top:40px;
}

.sig-line{
  width:260px;
  height:2px;
  background:#000;
  margin:10px auto;
}

.signature div{
  color:#0b2a4a;
  font-weight:700;
  margin:5px 0;
}

/* ===== Export Buttons ===== */
.buttons-export{
  display:flex;
  gap:10px;
  margin-top:25px;
  flex-wrap:wrap;
}

.buttons-export .btn{
  py:12px;
  px:24px;
}

/* ===== Responsive ===== */
@media(max-width:1400px){
  .sidebar{
    width:350px;
  }
}

@media(max-width:1100px){
  body{
    flex-direction:column;
  }
  
  .sidebar{
    width:100%;
    height:auto;
    order:1;
    border-bottom:2px solid #eee;
    border-right:none;
  }
  
  .main-content{
    order:2;
    height:auto;
  }
}
</style>
</head>

<body>

<!-- ===== SIDEBAR - Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­Ø±ÙŠØ± ===== -->
<div class="sidebar">
  <div class="sidebar-header">âš™ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
  
  <div id="msgBox" class="message"></div>

  <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ -->
  <div class="section">
    <div class="section-title" id="sec1Title">ğŸ‘¤ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</div>
    
    <div class="form-group">
      <label id="lbl0" for="registrationNumber">Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯:</label>
      <input type="text" id="registrationNumber" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯">
    </div>
    
    <div class="form-group">
      <label id="lbl1" for="studentName">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨:</label>
      <input type="text" id="studentName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨">
    </div>
    
    <div class="form-group">
      <label id="lbl2" for="studentCategory">Ø§Ù„ÙØ¦Ø©:</label>
      <input type="text" id="studentCategory" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„ØµØºØ±Ù‰">
    </div>
    
    <div class="form-group">
      <label id="lbl3" for="studentCenter">Ø§Ù„Ù…Ø±ÙƒØ²:</label>
      <input type="text" id="studentCenter" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø£ÙˆÙ„">
    </div>
  </div>

  <!-- Ø§Ù„Ø¯Ø±Ø¬Ø§Øª -->
  <div class="section">
    <div class="section-title" id="sec2Title">ğŸ“Š Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</div>
    <div id="gradesContainer"></div>
  </div>

  <!-- Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨ -->
  <div class="section">
    <div class="section-title" id="sec3Title">ğŸ“… Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨</div>
    
    <div class="form-group">
      <label id="lbl4" for="attendance">Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±:</label>
      <input type="number" id="attendance" placeholder="Ø£Ø¯Ø®Ù„ Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±" min="0" max="365">
    </div>
    
    <div class="form-group">
      <label id="lbl5" for="absence">Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨:</label>
      <input type="number" id="absence" placeholder="Ø£Ø¯Ø®Ù„ Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨" min="0" max="365">
    </div>
  </div>
  <div class="section">
    <div class="section-title" id="sec4Title">âœï¸ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</div>
    <div class="form-group">
      <label id="lbl6" for="sigName">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ±:</label>
      <input type="text" id="sigName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ±">
    </div>
  </div>

  <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØµØ¯ÙŠØ± -->
  <div class="section">
    <div class="section-title" id="sec5Title">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©</div>
    
    <div class="buttons-group">
      <button class="btn btn-pdf" onclick="exportPDF()">ğŸ“„ PDF</button>
      <button class="btn btn-png" onclick="exportPNG()">ğŸ–¼ï¸ ØµÙˆØ±Ø©</button>
    </div>
    
    <div class="buttons-group">
      <button class="btn btn-lang" id="langBtn" onclick="toggleLanguage()">ğŸŒ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù„ØºØ©</button>
      <button class="btn btn-primary" id="saveBtn" onclick="saveCertificate()">ğŸ’¾ Ø­ÙØ¸</button>
    </div>
    
    <div class="buttons-group">
      <button class="btn btn-secondary" id="downloadBtn" onclick="downloadSavedImage()" style="display:none;">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</button>
    </div>
    
    <div class="buttons-group">
      <button class="btn btn-secondary" id="backBtn" onclick="goBack()">â¬…ï¸ Ø±Ø¬ÙˆØ¹</button>
    </div>
  </div>
</div>

<!-- ===== MAIN CONTENT - Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© ===== -->
<div class="main-content">
  <div class="certificate" id="cert">
    <span class="bubble b1" aria-hidden="true"></span>
    <span class="bubble b2" aria-hidden="true"></span>

    <div class="header">
      <h1 id="title">Ù…Ø±ÙƒØ² Ø´Ø±ÙˆÙ‚ Ø¹Ø¯Ù† Ù„Ù„ØªØ¯Ø±ÙŠØ¨ ÙˆØ§Ù„ØªØ£Ù‡ÙŠÙ„</h1>
      <p id="subtitle">ØªØ­Øª Ø¥Ø´Ø±Ø§Ù ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ±Ø¨ÙŠØ© ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ…</p>
    </div>

    <div class="content">
      <div class="info-row">
        <span class="label" id="lblRegNum">Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯:</span>
        <span class="value" id="displayRegNum">-</span>
      </div>

      <div class="info-row">
        <span class="label" id="lblStudent">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨:</span>
        <span class="value" id="displayName">-</span>
      </div>

      <div class="info-row">
        <span class="label" id="lblCat">Ø§Ù„ÙØ¦Ø©:</span>
        <span class="value" id="displayCategory">-</span>
      </div>

      <div class="info-row">
        <span class="label" id="lblCenter">Ø§Ù„Ù…Ø±ÙƒØ²:</span>
        <span class="value" id="displayCenter">-</span>
      </div>

      <table>
        <thead>
          <tr>
            <th id="thSub">Ø§Ù„Ù…Ø§Ø¯Ø©</th>
            <th id="th1">ÙØµÙ„ Ø£ÙˆÙ„</th>
            <th id="th2">ÙØµÙ„ Ø«Ø§Ù†ÙŠ</th>
            <th id="thT">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
          </tr>
        </thead>
        <tbody id="gradesDisplay"></tbody>
      </table>

      <!-- ØµÙÙˆÙ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨ -->
      <table style="margin-top:20px;">
        <tr style="background:#fff7e6;border:1px solid #ddd;">
          <td style="border:1px solid #ddd;padding:12px;text-align:right;font-weight:700;color:#0b2a4a;">Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±</td>
          <td style="border:1px solid #ddd;padding:12px;text-align:center;font-weight:700;" id="displayAttendance">-</td>
        </tr>
        <tr style="background:#f0e6ff;border:1px solid #ddd;">
          <td style="border:1px solid #ddd;padding:12px;text-align:right;font-weight:700;color:#0b2a4a;">Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨</td>
          <td style="border:1px solid #ddd;padding:12px;text-align:center;font-weight:700;" id="displayAbsence">-</td>
        </tr>
      </table>

      <div class="result">
        <span id="lblResult">Ø§Ù„ØªÙ‚Ø¯ÙŠØ±:</span>
        <span id="gradeText">Ù…Ù…ØªØ§Ø²</span>
      </div>

      <div class="signature">
        <div id="lblMgr">Ù…Ø¯ÙŠØ±Ø© Ø§Ù„Ù…Ø±ÙƒØ²</div>
        <div class="sig-line"></div>
        <div id="displaySigName">-</div>
      </div>
    </div>
  </div>
</div>

<script>
let lang = "ar";
const subjectsAr = ['Ø§Ù„Ù‚Ø±Ø¢Ù†', 'Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©', 'Ø§Ù„Ø¹Ø±Ø¨ÙŠ', 'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª', 'Ø§Ù„Ø¹Ù„ÙˆÙ…', 'Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ', 'Ø§Ù„Ù†ÙˆØ±Ø§Ù†ÙŠÙ‡'];
const subjectsEn = ['Quran', 'Islamic Studies', 'Arabic', 'Mathematics', 'Science', 'English', 'Nuraniyah'];

const defaultGrades = [
  {subject: 'Ø§Ù„Ù‚Ø±Ø¢Ù†', first: 50, second: 50},
  {subject: 'Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©', first: 50, second: 50},
  {subject: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠ', first: 50, second: 50},
  {subject: 'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª', first: 50, second: 50},
  {subject: 'Ø§Ù„Ø¹Ù„ÙˆÙ…', first: 50, second: 50},
  {subject: 'Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ', first: 50, second: 50},
  {subject: 'Ø§Ù„Ù†ÙˆØ±Ø§Ù†ÙŠÙ‡', first: 50, second: 50}
];

let currentData = {
  registrationNumber: '',
  studentName: 'Ø¹Ù…Ø± Ø³Ø§Ù„Ù… Ù…Ø­Ø³Ù† Ù…Ø­Ù…Ø¯',
  studentCategory: 'Ø§Ù„ØµØºØ±Ù‰',
  studentCenter: 'Ø§Ù„Ø£ÙˆÙ„',
  sigName: 'Ø£. Ø´Ø±ÙˆÙ‚ Ø£Ø­Ù…Ø¯ ÙŠØ§Ø³ÙŠÙ†',
  attendance: 0,
  absence: 0,
  grades: JSON.parse(JSON.stringify(defaultGrades))
};

window.addEventListener('load', initializeEditor);

// ØªÙ†Ø¸ÙŠÙ localStorage Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¶Ø®Ù…Ø©
function cleanupStorageOnInit(){
  try {
    const stored = localStorage.getItem('certificates');
    if(stored) {
      let certs = JSON.parse(stored);
      let needsCleanup = false;
      
      // ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø©
      certs = certs.map(c => {
        const cleaned = {...c};
        if(cleaned.image) {
          delete cleaned.image;
          needsCleanup = true;
        }
        return cleaned;
      });
      
      // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¶Ø®Ù…Ø© Ø¬Ø¯Ø§Ù‹ØŒ Ø§Ø­ØªÙØ¸ Ø¨Ø¢Ø®Ø± 5 ÙÙ‚Ø·
      if(JSON.stringify(certs).length > 500000) { // > 500KB
        certs = certs.slice(-5);
        needsCleanup = true;
      }
      
      if(needsCleanup) {
        localStorage.setItem('certificates', JSON.stringify(certs));
      }
    }
  } catch(error) {
    console.log('ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error.message);
  }
}

function initializeEditor(){
  // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¶Ø®Ù…Ø© Ø£ÙˆÙ„Ø§Ù‹
  cleanupStorageOnInit();
  
  // Ù‚Ø±Ø§Ø¡Ø© Ù…Ø¹Ø±Ù Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ù…Ù† URL
  const urlParams = new URLSearchParams(window.location.search);
  const certId = urlParams.get('certId');
  
  // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…Ø¹Ø±ÙØŒ Ø­Ù…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage
  if(certId !== null){
    const certs = JSON.parse(localStorage.getItem('certificates') || '[]');
    const foundCert = certs.find(c => c.id === certId);
    if(foundCert){
      currentData = JSON.parse(JSON.stringify(foundCert));
      localStorage.setItem('currentCertId', certId);
      
      // ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¯ÙŠÙ‡Ø§ grades array
      if(!currentData.grades || !Array.isArray(currentData.grades) || currentData.grades.length === 0){
        currentData.grades = JSON.parse(JSON.stringify(defaultGrades));
      }
    }
  }
  
  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage Ø¥Ù† ÙˆØ¬Ø¯Øª (Ù„Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠØ§Ù‹)
  const certData = localStorage.getItem('currentCertData');
  if(certData && !certId){
    const loadedData = JSON.parse(certData);
    currentData = loadedData;
    
    // ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¯ÙŠÙ‡Ø§ grades array
    if(!currentData.grades || !Array.isArray(currentData.grades) || currentData.grades.length === 0){
      currentData.grades = JSON.parse(JSON.stringify(defaultGrades));
    }
  }
  
  // Ù…Ù„Ø¡ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
  document.getElementById('registrationNumber').value = currentData.registrationNumber;
  document.getElementById('studentName').value = currentData.studentName;
  document.getElementById('studentCategory').value = currentData.studentCategory;
  document.getElementById('studentCenter').value = currentData.studentCenter;
  document.getElementById('sigName').value = currentData.sigName;
  document.getElementById('attendance').value = currentData.attendance || 0;
  document.getElementById('absence').value = currentData.absence || 0;
  
  updatePlaceholders();
  renderGradesInputs();
  updateDisplay();
  attachInputListeners();
  
  // Ø²Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…ØªØ§Ø­ Ø¯Ø§Ø¦Ù…Ø§Ù‹ (ÙŠØ­ÙˆÙ„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©)
  document.getElementById('downloadBtn').style.display = 'inline-flex';
}

function renderGradesInputs(){
  const container = document.getElementById('gradesContainer');
  container.innerHTML = currentData.grades.map((g, i) => {
    const subjectName = lang === 'ar' ? subjectsAr[i] : subjectsEn[i];
    return `
      <div class="grade-row">
        <label>${subjectName}</label>
        <input type="number" class="grade-first" data-idx="${i}" value="${g.first}" min="0" max="50">
        <input type="number" class="grade-second" data-idx="${i}" value="${g.second}" min="0" max="50">
      </div>
    `;
  }).join('');
}

function attachInputListeners(){
  document.getElementById('registrationNumber').addEventListener('input', () => {
    currentData.registrationNumber = document.getElementById('registrationNumber').value;
    updateDisplay();
  });

  document.getElementById('studentName').addEventListener('input', () => {
    currentData.studentName = document.getElementById('studentName').value;
    updateDisplay();
  });

  document.getElementById('studentCategory').addEventListener('input', () => {
    currentData.studentCategory = document.getElementById('studentCategory').value;
    updateDisplay();
  });

  document.getElementById('studentCenter').addEventListener('input', () => {
    currentData.studentCenter = document.getElementById('studentCenter').value;
    updateDisplay();
  });

  document.getElementById('sigName').addEventListener('input', () => {
    currentData.sigName = document.getElementById('sigName').value;
    updateDisplay();
  });

  document.getElementById('attendance').addEventListener('input', () => {
    currentData.attendance = parseInt(document.getElementById('attendance').value) || 0;
    updateDisplay();
  });

  document.getElementById('absence').addEventListener('input', () => {
    currentData.absence = parseInt(document.getElementById('absence').value) || 0;
    updateDisplay();
  });
  
  attachGradeInputListeners();
}

function attachGradeInputListeners(){
  document.querySelectorAll('.grade-first, .grade-second').forEach(input => {
    input.addEventListener('input', () => {
      const idx = input.dataset.idx;
      const allFirst = document.querySelectorAll('.grade-first');
      const allSecond = document.querySelectorAll('.grade-second');
      
      const f = Math.min(50, Math.max(0, parseInt(allFirst[idx].value) || 0));
      const s = Math.min(50, Math.max(0, parseInt(allSecond[idx].value) || 0));
      
      allFirst[idx].value = f;
      allSecond[idx].value = s;
      
      currentData.grades[idx].first = f;
      currentData.grades[idx].second = s;
      
      updateDisplay();
    });
  });
}

function loadFromInputs(){
  const regNum = document.getElementById('registrationNumber').value.trim();
  const name = document.getElementById('studentName').value.trim();
  const category = document.getElementById('studentCategory').value.trim();
  const center = document.getElementById('studentCenter').value.trim();
  const sig = document.getElementById('sigName').value.trim();
  
  if(regNum) currentData.registrationNumber = regNum;
  if(name) currentData.studentName = name;
  if(category) currentData.studentCategory = category;
  if(center) currentData.studentCenter = center;
  if(sig) currentData.sigName = sig;
  
  currentData.attendance = parseInt(document.getElementById('attendance').value) || 0;
  currentData.absence = parseInt(document.getElementById('absence').value) || 0;
}

function updateDisplay(){
  document.getElementById('displayRegNum').textContent = currentData.registrationNumber || '-';
  document.getElementById('displayName').textContent = currentData.studentName;
  document.getElementById('displayCategory').textContent = currentData.studentCategory;
  document.getElementById('displayCenter').textContent = currentData.studentCenter;
  document.getElementById('displaySigName').textContent = currentData.sigName;
  document.getElementById('displayAttendance').textContent = currentData.attendance || 0;
  document.getElementById('displayAbsence').textContent = currentData.absence || 0;
  
  // ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ù…Ø¹ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø­Ø³Ø¨ Ø§Ù„Ù„ØºØ©
  const tbody = document.getElementById('gradesDisplay');
  let total = 0;
  
  tbody.innerHTML = currentData.grades.map((g, i) => {
    const subjectName = lang === 'ar' ? subjectsAr[i] : subjectsEn[i];
    const t = (g.first || 0) + (g.second || 0);
    total += t;
    return `
      <tr>
        <td class="subject">${subjectName}</td>
        <td>${g.first || 0}</td>
        <td>${g.second || 0}</td>
        <td>${t}</td>
      </tr>
    `;
  }).join('');
  
  const avg = Math.round(total / currentData.grades.length);
  
  const avgLbl = lang === 'ar' ? 'Ø§Ù„Ù…Ø¹Ø¯Ù„' : 'Average';
  const sumLbl = lang === 'ar' ? 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹' : 'Grand Total';
  
  tbody.innerHTML += `
    <tr class="total-row">
      <td colspan="3" id="lblAvg">${avgLbl}</td>
      <td id="avg">${avg}</td>
    </tr>
    <tr class="total-row">
      <td colspan="3" id="lblSum">${sumLbl}</td>
      <td id="grandTotal">${total}</td>
    </tr>
  `;
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø¯ÙŠØ±
  let gradeAr, gradeEn;
  if(avg >= 95){
    gradeAr = 'Ù…Ù…ØªØ§Ø²';
    gradeEn = 'Excellent';
  } else if(avg >= 85){
    gradeAr = 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹';
    gradeEn = 'Very Good';
  } else if(avg >= 75){
    gradeAr = 'Ø¬ÙŠØ¯';
    gradeEn = 'Good';
  } else {
    gradeAr = 'Ù…Ù‚Ø¨ÙˆÙ„';
    gradeEn = 'Satisfactory';
  }
  
  document.getElementById('gradeText').textContent = lang === 'ar' ? gradeAr : gradeEn;
}

function saveCertificate(){
  loadFromInputs();
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
  if(!currentData.registrationNumber || !currentData.studentName){
    showMsg('âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯ ÙˆØ§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨', 'error');
    return;
  }
  
  showMsg('â³ Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©...', 'info');
  
  // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø¥Ù„Ù‰ ØµÙˆØ±Ø© Base64
  (async () => {
    try {
      if (document.fonts && document.fonts.ready) await document.fonts.ready;
    } catch (e) {}

    const orig = document.getElementById('cert');
    const rect = orig.getBoundingClientRect();
    const clone = orig.cloneNode(true);

    clone.style.position = 'absolute';
    clone.style.left = '-10000px';
    clone.style.width = rect.width + 'px';
    clone.style.height = rect.height + 'px';

    document.body.appendChild(clone);

    const canvas = await html2canvas(clone, {
      scale: Math.min(4, (window.devicePixelRatio || 1) * 3),
      useCORS: true,
      backgroundColor: '#ffffff',
      width: Math.ceil(rect.width),
      height: Math.ceil(rect.height),
      windowWidth: Math.ceil(rect.width),
      windowHeight: Math.ceil(rect.height)
    });

    document.body.removeChild(clone);

    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ Ø¥Ù„Ù‰ Base64 (Ù†Ø­Ø§ÙˆÙ„ Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø© Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø¬Ù… ÙˆØ¯Ø±Ø¡ Ø®Ø·Ø£ Ø§Ù…ØªÙ„Ø§Ø¡ localStorage)
    function compressCanvasToDataUrl(canvas, mimeType = 'image/jpeg'){
      let quality = 0.8;
      let dataUrl = canvas.toDataURL(mimeType, quality);
      // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ù‹Ø§ØŒ Ù‚Ù„Ù„ Ø§Ù„Ø¬ÙˆØ¯Ø© ØªØ¯Ø±ÙŠØ¬ÙŠÙ‹Ø§
      const maxSize = 250 * 1024; // 250KB
      while(dataUrl.length > maxSize && quality > 0.35){
        quality -= 0.15;
        try {
          dataUrl = canvas.toDataURL(mimeType, Math.max(0.35, quality));
        } catch(e){ break; }
      }
      return dataUrl;
    }

    let imageBase64 = null;
    try {
      // Ø§Ø³ØªØ®Ø¯Ù… JPEG Ù…Ø¶ØºÙˆØ· Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø¬Ù…
      imageBase64 = compressCanvasToDataUrl(canvas, 'image/jpeg');
    } catch(e){
      console.warn('ØªØ¹Ø°Ø± Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø©ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… PNG:', e);
      imageBase64 = canvas.toDataURL('image/png');
    }

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ø§Ù„ØµÙˆØ±Ø© (ØªØ¶Ù…ÙŠÙ† Ø§Ù„Ù„ØºØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©)
    const certDataWithImage = {
      ...currentData,
      image: imageBase64,
      lang: lang || 'ar',
      savedAt: new Date().toISOString()
    };
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¯ÙˆÙ† Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ù„ÙŠ (Ù†Ø³Ø®Ø© Ø¨Ø¯ÙŠÙ„Ø©)
    const certDataWithoutImage = {
      ...currentData,
      lang: lang || 'ar',
      savedAt: new Date().toISOString()
    };
    
    // Ø­ÙØ¸ ÙÙŠ localStorage Ù…Ø¹ Ø§Ù„ØµÙˆØ±Ø©
    try {
      let certs = [];
      const stored = localStorage.getItem('certificates');
      if(stored) {
        try {
          certs = JSON.parse(stored);
          // ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØµÙˆØ± Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
          certs = certs.map(c => {
            const cleaned = {...c};
            delete cleaned.image;
            return cleaned;
          });
        } catch(e) {
          console.log('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„ØŒ Ø¨Ø¯Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©');
          certs = [];
        }
      }
      
      const certId = localStorage.getItem('currentCertId') || Date.now().toString();
      
      // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© ÙˆØªØ­Ø¯ÙŠØ«Ù‡Ø§ Ø£Ùˆ Ø¥Ø¶Ø§ÙØªÙ‡Ø§
      const certIndex = certs.findIndex(c => c.id === certId);
      
      // Ø§Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ù…Ø¹ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø´ÙƒÙ„ Ù…Ù†ÙØµÙ„
      let certsWithImages = [];
      const storedWithImages = localStorage.getItem('certificates_with_images');
      if(storedWithImages) {
        try {
          certsWithImages = JSON.parse(storedWithImages);
        } catch(e) {
          certsWithImages = [];
        }
      }
      
      const imgCertIndex = certsWithImages.findIndex(c => c.id === certId);
      if(imgCertIndex !== -1){
        certsWithImages[imgCertIndex] = certDataWithImage;
      } else {
        certDataWithImage.id = certId;
        certsWithImages.push(certDataWithImage);
      }
      
      // Ø­Ø§ÙˆÙ„ Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±ØŒ Ù„ÙƒÙ† Ø¥Ø°Ø§ Ø§Ù…ØªÙ„Ø£ localStorage ÙÙ†ØªØ¬Ø§ÙˆØ² Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø© Ù…Ø­Ù„ÙŠØ§Ù‹
      try {
        localStorage.setItem('certificates_with_images', JSON.stringify(certsWithImages));
      } catch(imgErr) {
        console.warn('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„ØµÙˆØ± Ù…Ø­Ù„ÙŠØ§Ù‹ØŒ Ø³ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ Ø§Ù„ØµÙˆØ±Ø©:', imgErr);
        // Ù‚Ù… Ø¨Ø¥Ø²Ø§Ù„Ø© Ø®Ø§ØµÙŠØ© Ø§Ù„ØµÙˆØ±Ø© Ù…Ù† Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ù„ØªÙØ±ÙŠØº Ø§Ù„Ù…Ø³Ø§Ø­Ø©
        try {
          certsWithImages = certsWithImages.map(c => { const copy = {...c}; delete copy.image; return copy; });
          localStorage.setItem('certificates_with_images', JSON.stringify(certsWithImages));
        } catch(e2){
          // Ø¥Ø°Ø§ ÙØ´Ù„ Ø­ØªÙ‰ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ†Ø¸ÙŠÙØŒ Ø§Ø­Ø°Ù Ø§Ù„Ù…ÙØªØ§Ø­ Ø¨Ø£ÙƒÙ…Ù„Ù‡
          try { localStorage.removeItem('certificates_with_images'); } catch(e3){}
        }
        showMsg('âš ï¸ Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ Ù…Ù…ØªÙ„Ø¦Ø©ØŒ Ø§Ù„ØµÙˆØ±Ø© Ù„Ù… ØªØ­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹', 'error');
      }
      
      if(certIndex !== -1){
        certs[certIndex] = certDataWithoutImage;
      } else {
        certDataWithoutImage.id = certId;
        certs.push(certDataWithoutImage);
      }
      
      // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙˆØ± Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
      const certsClean = certs.map(c => {
        const cleaned = {...c};
        delete cleaned.image;
        return cleaned;
      });
      
      localStorage.setItem('certificates', JSON.stringify(certsClean));
      localStorage.setItem('currentCertId', certId);
      localStorage.setItem('currentCertData', JSON.stringify(certDataWithoutImage));
      
      console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„ØµÙˆØ±Ø© ÙÙŠ localStorage');
      console.log('Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª:', certsClean.length);
    } catch (storageError) {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ localStorage:', storageError.name, storageError.message);
      
      // Ø¥Ø°Ø§ ÙƒØ§Ù† localStorage Ù…Ù…ØªÙ„Ø¦Ø§Ù‹
      if(storageError.name === 'QuotaExceededError') {
        console.log('ğŸ—‘ï¸ localStorage Ù…Ù…ØªÙ„Ø¦ - Ù…Ø­Ø§ÙˆÙ„Ø© ØªÙ†Ø¸ÙŠÙ...');
        try {
          // Ø§Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙˆØ£Ø¨Ù‚Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø­Ø¯Ø« ÙÙ‚Ø·
          localStorage.removeItem('certificates');
          localStorage.removeItem('currentCertData');
          localStorage.removeItem('certificates_with_images');
          
          // Ø«Ù… Ø§Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙ‚Ø·
          const freshData = {...certDataWithImage, id: Date.now().toString()};
          localStorage.setItem('currentCertId', freshData.id);
          localStorage.setItem('currentCertData', JSON.stringify({...freshData, image: undefined}));
          
          // Ø§Ø­ÙØ¸ ÙÙŠ array Ø¬Ø¯ÙŠØ¯
          localStorage.setItem('certificates', JSON.stringify([{...freshData, image: undefined}]));
          localStorage.setItem('certificates_with_images', JSON.stringify([freshData]));
          
          showMsg('âœ… ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø°Ø§ÙƒØ±Ø© ÙˆØ­ÙØ¸ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
          console.log('âœ… ØªÙ… Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø¨Ù†Ø¬Ø§Ø­');
          return; // Ù†Ø¬Ø­ Ø§Ù„ØªÙ†Ø¸ÙŠÙ ÙˆØ§Ù„Ø­ÙØ¸
        } catch(cleanError) {
          console.error('ÙØ´Ù„ Ø§Ù„ØªÙ†Ø¸ÙŠÙ:', cleanError);
          showMsg('âš ï¸ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ù…Ù…ØªÙ„Ø¦Ø© - Ø³ÙŠØªÙ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„Ù„Ø­ÙØ¸', 'success');
        }
      } else {
        showMsg('âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ù„ÙŠ: ' + storageError.message, 'error');
      }
    }
    
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ± Ù…Ø¹ Ø§Ù„ØµÙˆØ±Ø©
    try {
      const response = await fetch('/api/certificates/save', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          registrationNumber: currentData.registrationNumber,
          studentName: currentData.studentName,
          studentCategory: currentData.studentCategory,
          certification: currentData,
          image: imageBase64
        })
      });

      if (response.ok) {
        const result = await response.json();
        console.log('âœ… ØªÙ… Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±:', result);
        showMsg('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© ÙˆØ§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­!', 'success');
      } else {
        const errorText = await response.text();
        console.warn('âš ï¸ Ø®Ø·Ø£ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±:', response.status, errorText);
        showMsg('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ (Ø§Ù„Ø³ÙŠØ±ÙØ±: ' + response.status + ')', 'success');
      }
    } catch (error) {
      console.log('â„¹ï¸ Ø§Ù„Ø³ÙŠØ±ÙØ± ØºÙŠØ± Ù…ØªØ§Ø­:', error.message);
      showMsg('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¨Ù†Ø¬Ø§Ø­', 'success');
    }
  })();
}

function goBack(){
  localStorage.removeItem('currentCertId');
  localStorage.removeItem('currentCertData');
  window.location.href = 'admin.html';
}

function downloadSavedImage(){
  // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¥Ù„Ù‰ ØµÙˆØ±Ø© ÙˆØªÙ†Ø²ÙŠÙ„Ù‡Ø§
  (async () => {
    try {
      if (document.fonts && document.fonts.ready) await document.fonts.ready;
    } catch (e) {}

    const orig = document.getElementById('cert');
    const rect = orig.getBoundingClientRect();
    const clone = orig.cloneNode(true);

    clone.style.position = 'absolute';
    clone.style.left = '-10000px';
    clone.style.width = rect.width + 'px';
    clone.style.height = rect.height + 'px';

    document.body.appendChild(clone);

    const canvas = await html2canvas(clone, {
      scale: Math.min(4, (window.devicePixelRatio || 1) * 3),
      useCORS: true,
      backgroundColor: '#ffffff',
      width: Math.ceil(rect.width),
      height: Math.ceil(rect.height),
      windowWidth: Math.ceil(rect.width),
      windowHeight: Math.ceil(rect.height)
    });

    document.body.removeChild(clone);

    // ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©
    const link = document.createElement('a');
    link.download = `${currentData.studentName || 'certificate'}.png`;
    link.href = canvas.toDataURL('image/png');
    link.click();
  })();
}

function exportPDF(){
  const {jsPDF} = window.jspdf;
  const pdf = new jsPDF("p","pt","a4");
  pdf.html(document.getElementById("cert"), {
    callback: () => pdf.save("certificate.pdf"),
    x: 20, y: 20, width: 560, windowWidth: 900
  });
}

function exportPNG(){
  (async () => {
    try { if (document.fonts && document.fonts.ready) await document.fonts.ready; } catch (e) {}

    const orig = document.getElementById('cert');
    const rect = orig.getBoundingClientRect();
    const clone = orig.cloneNode(true);

    clone.style.position = 'absolute';
    clone.style.left = '-10000px';
    clone.style.width = rect.width + 'px';
    clone.style.height = rect.height + 'px';

    document.body.appendChild(clone);

    const canvas = await html2canvas(clone, {
      scale: Math.min(4, (window.devicePixelRatio || 1) * 3),
      useCORS: true,
      backgroundColor: '#ffffff',
      width: Math.ceil(rect.width),
      height: Math.ceil(rect.height),
      windowWidth: Math.ceil(rect.width),
      windowHeight: Math.ceil(rect.height)
    });

    document.body.removeChild(clone);

    const link = document.createElement('a');
    link.download = 'certificate.png';
    link.href = canvas.toDataURL('image/png');
    link.click();
  })();
}

function toggleLanguage(){
  lang = lang === 'ar' ? 'en' : 'ar';
  document.documentElement.lang = lang;
  document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
  
  // ØªØ­Ø¯ÙŠØ« Ù†ØµÙˆØµ Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø£ÙŠØ³Ø±
  if(lang === 'ar'){
    // Ø¹Ù†ÙˆØ§Ù† Sidebar
    const sidebarHeader = document.querySelector('.sidebar-header');
    if(sidebarHeader) sidebarHeader.textContent = 'âš™ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…';
    
    // Section titles
    const sections = {
      'sec1Title': 'ğŸ‘¤ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨',
      'sec2Title': 'ğŸ“Š Ø§Ù„Ø¯Ø±Ø¬Ø§Øª',
      'sec3Title': 'ğŸ“… Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨',
      'sec4Title': 'âœï¸ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹',
      'sec5Title': 'ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©'
    };
    
    // Labels
    const labels = {
      'lbl0': 'Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯:',
      'lbl1': 'Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨:',
      'lbl2': 'Ø§Ù„ÙØ¦Ø©:',
      'lbl3': 'Ø§Ù„Ù…Ø±ÙƒØ²:',
      'lbl4': 'Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±:',
      'lbl5': 'Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨:',
      'lbl6': 'Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ±:'
    };
    
    // Buttons
    const btns = {
      'langBtn': 'ğŸŒ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù„ØºØ©',
      'saveBtn': 'ğŸ’¾ Ø­ÙØ¸',
      'downloadBtn': 'â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©',
      'backBtn': 'â¬…ï¸ Ø±Ø¬ÙˆØ¹'
    };
    
    // Update certificate
    const certLabels = {
      'title': 'Ù…Ø±ÙƒØ² Ø´Ø±ÙˆÙ‚ Ø¹Ø¯Ù† Ù„Ù„ØªØ¯Ø±ÙŠØ¨ ÙˆØ§Ù„ØªØ£Ù‡ÙŠÙ„',
      'subtitle': 'ØªØ­Øª Ø¥Ø´Ø±Ø§Ù ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ±Ø¨ÙŠØ© ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ…',
      'lblRegNum': 'Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯:',
      'lblStudent': 'Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨:',
      'lblCat': 'Ø§Ù„ÙØ¦Ø©:',
      'lblCenter': 'Ø§Ù„Ù…Ø±ÙƒØ²:',
      'lblResult': 'Ø§Ù„ØªÙ‚Ø¯ÙŠØ±:',
      'lblMgr': 'Ù…Ø¯ÙŠØ±Ø© Ø§Ù„Ù…Ø±ÙƒØ²',
      'thSub': 'Ø§Ù„Ù…Ø§Ø¯Ø©',
      'th1': 'ÙØµÙ„ Ø£ÙˆÙ„',
      'th2': 'ÙØµÙ„ Ø«Ø§Ù†ÙŠ',
      'thT': 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹'
    };
    
    Object.entries(sections).forEach(([id, text]) => {
      const el = document.getElementById(id);
      if(el) el.textContent = text;
    });
    
    Object.entries(labels).forEach(([id, text]) => {
      const el = document.getElementById(id);
      if(el) el.textContent = text;
    });
    
    Object.entries(btns).forEach(([id, text]) => {
      const el = document.getElementById(id);
      if(el) el.textContent = text;
    });
    
    Object.entries(certLabels).forEach(([id, text]) => {
      const el = document.getElementById(id);
      if(el) el.textContent = text;
    });
    
  } else {
    // English
    const sections = {
      'sec1Title': 'ğŸ‘¤ Student Information',
      'sec2Title': 'ğŸ“Š Grades',
      'sec3Title': 'ğŸ“… Attendance',
      'sec4Title': 'âœï¸ Signature',
      'sec5Title': 'ğŸ“¥ Export Certificate'
    };
    
    const labels = {
      'lbl0': 'Registration Number:',
      'lbl1': 'Student Name:',
      'lbl2': 'Category:',
      'lbl3': 'Center:',
      'lbl4': 'Days Present:',
      'lbl5': 'Days Absent:',
      'lbl6': 'Director Name:'
    };
    
    const btns = {
      'langBtn': 'ğŸŒ Toggle Language',
      'saveBtn': 'ğŸ’¾ Save',
      'downloadBtn': 'â¬‡ï¸ Download Saved Image',
      'backBtn': 'â¬…ï¸ Back'
    };
    
    const certLabels = {
      'title': 'Shorouk Training Center',
      'subtitle': 'Under supervision of the Ministry of Education',
      'lblRegNum': 'Registration Number:',
      'lblStudent': 'Student Name:',
      'lblCat': 'Category:',
      'lblCenter': 'Center:',
      'lblResult': 'Grade:',
      'lblMgr': 'Center Director',
      'thSub': 'Subject',
      'th1': 'First Term',
      'th2': 'Second Term',
      'thT': 'Total'
    };
    
    const sidebarHeader = document.querySelector('.sidebar-header');
    if(sidebarHeader) sidebarHeader.textContent = 'âš™ï¸ Control Panel';
    
    Object.entries(sections).forEach(([id, text]) => {
      const el = document.getElementById(id);
      if(el) el.textContent = text;
    });
    
    Object.entries(labels).forEach(([id, text]) => {
      const el = document.getElementById(id);
      if(el) el.textContent = text;
    });
    
    Object.entries(btns).forEach(([id, text]) => {
      const el = document.getElementById(id);
      if(el) el.textContent = text;
    });
    
    Object.entries(certLabels).forEach(([id, text]) => {
      const el = document.getElementById(id);
      if(el) el.textContent = text;
    });
  }
  
  // ØªØ­Ø¯ÙŠØ« Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ù€ Placeholders ÙˆØ§Ù„ØªÙ‚Ø¯ÙŠØ±
  updateGradesLabels();
  updatePlaceholders();
  updateDisplay();
}

function showMsg(text, type){
  const box = document.getElementById('msgBox');
  box.textContent = text;
  box.className = 'message ' + type + ' show';
  setTimeout(() => box.classList.remove('show'), 3000);
}

function updatePlaceholders(){
  if(lang === 'ar'){
    document.getElementById('registrationNumber').placeholder = 'Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯';
    document.getElementById('studentName').placeholder = 'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨';
    document.getElementById('studentCategory').placeholder = 'Ù…Ø«Ø§Ù„: Ø§Ù„ØµØºØ±Ù‰';
    document.getElementById('studentCenter').placeholder = 'Ù…Ø«Ø§Ù„: Ø§Ù„Ø£ÙˆÙ„';
    document.getElementById('sigName').placeholder = 'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ±';
    document.getElementById('attendance').placeholder = 'Ø£Ø¯Ø®Ù„ Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±';
    document.getElementById('absence').placeholder = 'Ø£Ø¯Ø®Ù„ Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨';
  } else {
    document.getElementById('registrationNumber').placeholder = 'Enter registration number';
    document.getElementById('studentName').placeholder = 'Enter student name';
    document.getElementById('studentCategory').placeholder = 'Example: Group A';
    document.getElementById('studentCenter').placeholder = 'Example: First';
    document.getElementById('sigName').placeholder = 'Enter director name';
    document.getElementById('attendance').placeholder = 'Enter days present';
    document.getElementById('absence').placeholder = 'Enter days absent';
  }
}

function updateGradesLabels(){
  renderGradesInputs();
  attachGradeInputListeners();
}
</script>

</body>
</html>

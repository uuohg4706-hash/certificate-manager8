<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø·Ù„Ø§Ø¨ - Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±</title>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box;margin:0;padding:0}

body{
  font-family:'Cairo',sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  padding: 20px;
}

.container{
  max-width: 1100px;
  margin: 0 auto;
}

/* ===== Ø§Ù„Ù‡ÙŠØ¯Ø± ===== */
.header{
  background: #fff;
  padding: 30px;
  border-radius: 15px;
  text-align: center;
  margin-bottom: 30px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

.header h1{
  color: #333;
  font-size: 2rem;
  margin-bottom: 10px;
}

.header p{
  color: #666;
  font-size: 1.1rem;
}

.logo{
  font-size: 3rem;
  margin-bottom: 10px;
}

/* ===== Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¨Ø­Ø« ===== */
.search-section{
  background: #fff;
  padding: 30px;
  border-radius: 15px;
  margin-bottom: 30px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

.search-group{
  display: flex;
  gap: 15px;
  flex-wrap: wrap;
}

.search-input{
  flex: 1;
  min-width: 250px;
  padding: 15px;
  border: 2px solid #ddd;
  border-radius: 8px;
  font-family: 'Cairo', sans-serif;
  font-size: 1rem;
  transition: all 0.3s;
}

.search-input:focus{
  outline: none;
  border-color: #667eea;
  background: #fff;
  box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
}

.search-btn{
  padding: 15px 40px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: #fff;
  border: none;
  border-radius: 8px;
  font-weight: 700;
  cursor: pointer;
  font-size: 1rem;
  transition: all 0.3s;
  font-family: 'Cairo', sans-serif;
}

.search-btn:hover{
  transform: translateY(-2px);
  box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
}

.search-btn:active{
  transform: translateY(0);
}

/* ===== Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ===== */
.message{
  padding: 20px;
  border-radius: 8px;
  margin-bottom: 20px;
  font-weight: 600;
  display: none;
}

.message.show{
  display: block;
  animation: slideDown 0.3s ease;
}

.message.success{
  background: #d4edda;
  color: #155724;
  border: 2px solid #c3e6cb;
}

.message.error{
  background: #f8d7da;
  color: #721c24;
  border: 2px solid #f5c6cb;
}

.message.info{
  background: #d1ecf1;
  color: #0c5460;
  border: 2px solid #bee5eb;
}

@keyframes slideDown{
  from{
    transform: translateY(-20px);
    opacity: 0;
  }
  to{
    transform: translateY(0);
    opacity: 1;
  }
}

/* ===== Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« ===== */
.results-container{
  display: none;
}

.results-container.show{
  display: block;
}

/* ===== Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© ===== */
.certificate-card{
  background: #fff;
  border-radius: 15px;
  overflow: hidden;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  margin-bottom: 30px;
}

.certificate-image{
  width: 100%;
  max-height: 500px;
  object-fit: cover;
  background: #f0f0f0;
  display: block;
}

.certificate-info{
  padding: 30px;
}

.info-row{
  display: flex;
  gap: 20px;
  margin-bottom: 20px;
  padding: 15px;
  background: #f9f9f9;
  border-radius: 8px;
  border-right: 4px solid #667eea;
}

.info-label{
  font-weight: 700;
  color: #333;
  min-width: 150px;
  flex-shrink: 0;
}

.info-value{
  color: #666;
  flex: 1;
}

/* ===== Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª ===== */
.grades-table{
  width: 100%;
  border-collapse: collapse;
  margin: 20px 0;
  background: #fff;
}

.grades-table th{
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: #fff;
  padding: 15px;
  text-align: right;
  font-weight: 700;
}

.grades-table td{
  padding: 12px 15px;
  border-bottom: 1px solid #eee;
  text-align: center;
}

.grades-table tr:hover{
  background: #f9f9f9;
}

.subject-name{
  text-align: right;
  font-weight: 600;
  color: #333;
}

/* ===== ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø¯Ø±Ø¬Ø§Øª ===== */
.grade-cell{
  font-weight: 700;
  border-radius: 6px;
  padding: 8px 12px;
  color: #fff;
}

.grade-excellent{
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
}

.grade-very-good{
  background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
}

.grade-good{
  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
}

.grade-acceptable{
  background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
}

.months-container{
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin: 20px 0;
}

.month-card{
  background: #fff;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  border-top: 4px solid #667eea;
}

.month-header{
  font-size: 1.1rem;
  font-weight: 700;
  color: #333;
  margin-bottom: 15px;
  text-align: right;
}

.month-grades{
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.month-grade-row{
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px;
  background: #f9f9f9;
  border-radius: 6px;
}

.month-grade-label{
  font-weight: 600;
  color: #555;
  flex: 1;
  text-align: right;
}

.month-grade-value{
  font-weight: 700;
  font-size: 1.2rem;
  min-width: 60px;
  text-align: center;
  border-radius: 6px;
  padding: 4px 8px;
  color: #fff;
}

/* ===== Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ¨Ø§Ø±Ùƒ ===== */
.congratulations{
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  color: #fff;
  padding: 30px;
  border-radius: 15px;
  text-align: center;
  margin: 30px 0;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  animation: pulse 2s infinite;
}

.congratulations h2{
  font-size: 2rem;
  margin-bottom: 10px;
}

.congratulations p{
  font-size: 1.2rem;
  font-weight: 600;
}

@keyframes pulse{
  0%, 100%{
    transform: scale(1);
  }
  50%{
    transform: scale(1.02);
  }
}

/* ===== Ø§Ù„Ø£Ø²Ø±Ø§Ø± ===== */
.action-buttons{
  display: flex;
  gap: 15px;
  margin-top: 30px;
  flex-wrap: wrap;
}

.btn{
  flex: 1;
  min-width: 150px;
  padding: 12px 25px;
  border: none;
  border-radius: 8px;
  font-weight: 700;
  cursor: pointer;
  font-family: 'Cairo', sans-serif;
  font-size: 1rem;
  transition: all 0.3s;
}

.btn-primary{
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: #fff;
}

.btn-primary:hover{
  transform: translateY(-2px);
  box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
}

.btn-secondary{
  background: #e0e0e0;
  color: #333;
}

.btn-secondary:hover{
  background: #d0d0d0;
}

/* ===== Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ© ===== */
.empty-state{
  text-align: center;
  padding: 60px 20px;
  color: #999;
}

.empty-state svg{
  width: 80px;
  height: 80px;
  margin-bottom: 20px;
  opacity: 0.5;
}

.empty-state p{
  font-size: 1.2rem;
  color: #666;
}

/* ===== Responsive ===== */
@media(max-width: 768px){
  .header h1{
    font-size: 1.5rem;
  }
  
  .search-group{
    flex-direction: column;
  }
  
  .search-input,
  .search-btn{
    width: 100%;
  }
  
  .info-row{
    flex-direction: column;
  }
  
  .congratulations h2{
    font-size: 1.5rem;
  }
  
  .congratulations p{
    font-size: 1rem;
  }
  
  .grades-table{
    font-size: 0.9rem;
  }
  
  .grades-table th,
  .grades-table td{
    padding: 10px 8px;
  }
}

/* ===== Ø·Ø¨Ø§Ø¹Ø© ===== */
@media print{
  body{
    background: #fff;
  }
  
  .search-section,
  .action-buttons,
  .header p{
    display: none;
  }
  
  .certificate-card{
    box-shadow: none;
    border: 2px solid #ddd;
  }
}
</style>
</head>

<body>

<!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
<div class="header">
  <div class="logo">ğŸ“</div>
  <h1>Ø¨ÙˆØ§Ø¨Ø© Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø·Ù„Ø§Ø¨</h1>
  <p>Ù…Ø±ÙƒØ² Ø´Ø±ÙˆÙ‚ Ø¹Ø¯Ù† Ù„Ù„ØªØ¯Ø±ÙŠØ¨ ÙˆØ§Ù„ØªØ£Ù‡ÙŠÙ„</p>
</div>

<!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¨Ø­Ø« -->
<div class="container">
  <div class="search-section">
    <div class="message" id="msgBox"></div>
    
    <div class="search-group">
      <input 
        type="text" 
        class="search-input" 
        id="searchInput" 
        placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯..." 
        onkeypress="if(event.key === 'Enter') searchStudent()"
      >
      <button class="search-btn" onclick="searchStudent()">ğŸ” Ø¨Ø­Ø«</button>
    </div>
  </div>

  <!-- Ø§Ù„Ù†ØªØ§Ø¦Ø¬ -->
  <div class="results-container" id="resultsContainer">
    <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ø¹Ø¨Ø± JavaScript -->
  </div>

  <!-- Ø­Ø§Ù„Ø© ÙØ§Ø±ØºØ© -->
  <div class="empty-state" id="emptyState" style="display: none;">
    <p>ğŸ” Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</p>
  </div>
</div>

<script>
function showMsg(text, type){
  const msgBox = document.getElementById('msgBox');
  msgBox.textContent = text;
  msgBox.className = `message show ${type}`;
  
  setTimeout(() => {
    msgBox.classList.remove('show');
  }, 4000);
}

async function searchStudent(){
  const searchTerm = document.getElementById('searchInput').value.trim();
  
  if(!searchTerm){
    showMsg('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯', 'error');
    return;
  }
  
  showMsg('â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...', 'info');
  
  try {
    let certs = [];
    
    // Ø¬Ù„Ø¨ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ø£ÙˆÙ„Ø§Ù‹
    try {
      const response = await fetch('/api/certificates/list');
      if (response.ok) {
        certs = await response.json();
      }
    } catch (serverError) {
      // Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ø³ÙŠØ±ÙØ±ØŒ Ø§Ø³ØªØ®Ø¯Ù… localStorage
      console.warn('âš ï¸ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©...');
      certs = JSON.parse(localStorage.getItem('certificates') || '[]');
    }
    
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯
    const results = certs.filter(cert => 
      cert.registrationNumber && String(cert.registrationNumber) === searchTerm
    );
    
    if(results.length === 0){
      showMsg('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ø´Ù‡Ø§Ø¯Ø© Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯ Ù‡Ø°Ø§', 'error');
      document.getElementById('resultsContainer').classList.remove('show');
      document.getElementById('emptyState').style.display = 'block';
      return;
    }
    
    // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    displayResults(results);
    document.getElementById('emptyState').style.display = 'none';
    document.getElementById('resultsContainer').classList.add('show');
    showMsg('âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«:', error);
    showMsg('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©', 'error');
  }
}

function displayResults(results){
  const container = document.getElementById('resultsContainer');
  
  container.innerHTML = results.map((cert) => {
    const lang = cert.lang === 'en' ? 'en' : 'ar';
    const dir = lang === 'en' ? 'ltr' : 'rtl';
    const align = lang === 'en' ? 'left' : 'right';
    const labels = lang === 'en' ? {
      reg: 'Registration Number:',
      student: 'Student Name:',
      cat: 'Category:',
      center: 'Center:',
      gradesTitle: 'ğŸ“Š Grades',
      presence: 'Days Present:',
      absence: 'Days Absent:',
      totalLabel: 'Grand Total:',
      resultLabel: 'Overall Grade',
      print: 'ğŸ–¨ï¸ Print',
      download: 'â¬‡ï¸ Download Image'
    } : {
      reg: 'Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯:',
      student: 'Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨:',
      cat: 'Ø§Ù„ÙØ¦Ø©:',
      center: 'Ø§Ù„Ù…Ø±ÙƒØ²:',
      gradesTitle: 'ğŸ“Š Ø§Ù„Ø¯Ø±Ø¬Ø§Øª',
      presence: 'Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±:',
      absence: 'Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨:',
      totalLabel: 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¹Ø§Ù…:',
      resultLabel: 'Ø§Ù„ØªÙ‚Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…',
      print: 'ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©',
      download: 'â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©'
    };

    return `
    <div class="certificate-card" data-cert-id="${cert.id}" dir="${dir}" style="text-align:${align}">
      ${cert.image ? `
        <img src="${cert.image}" alt="Certificate ${cert.studentName}" class="certificate-image">
      ` : ''}
      <div class="certificate-info">
        <div class="congratulations">
          <h2>${lang === 'en' ? 'ğŸ‰ Congratulations' : 'ğŸ‰ ØªØ¨Ø§Ø±Ùƒ'}</h2>
          <p>${lang === 'en' ? 'Success and excellence for' : 'Ù†Ø¬Ø§Ø­ ÙˆØªÙÙˆÙ‚ Ù„Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„ÙƒØ±ÙŠÙ…'} <strong>${cert.studentName}</strong></p>
        </div>
        <h3 style="margin-bottom: 20px; color: #333;">${labels.gradesTitle}</h3>
        <div class="info-row">
          <span class="info-label">${labels.reg}</span>
          <span class="info-value">${cert.registrationNumber}</span>
        </div>
        <div class="info-row">
          <span class="info-label">${labels.student}</span>
          <span class="info-value">${cert.studentName}</span>
        </div>
        <div class="info-row">
          <span class="info-label">${labels.cat}</span>
          <span class="info-value">${cert.studentCategory}</span>
        </div>
        <div class="info-row">
          <span class="info-label">${labels.center}</span>
          <span class="info-value">${cert.studentCenter}</span>
        </div>
        <table class="grades-table">
          <thead>
            <tr>
              <th>${lang === 'en' ? 'Subject' : 'Ø§Ù„Ù…Ø§Ø¯Ø©'}</th>
              <th>${lang === 'en' ? 'Month 1' : 'Ø´Ù‡Ø± 1'}</th>
              <th>${lang === 'en' ? 'Month 2' : 'Ø´Ù‡Ø± 2'}</th>
              <th>${lang === 'en' ? 'Grade' : 'Ø§Ù„ØªÙ‚Ø¯ÙŠØ±'}</th>
            </tr>
          </thead>
          <tbody>
            ${generateGradesRows(cert.grades, lang)}
            <tr style="background: #f0f0f0; font-weight: 700;">
              <td colspan="3" style="text-align: ${align};">${labels.totalLabel}</td>
              <td>${calculateTotal(cert.grades)}</td>
            </tr>
          </tbody>
        </table>
        <div style="margin-top: 25px;">
          <h3 style="margin-bottom: 15px; color: #333;">${lang === 'en' ? 'ğŸ“… Attendance' : 'ğŸ“… Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨'}</h3>
          <div class="info-row">
            <span class="info-label">${labels.presence}</span>
            <span class="info-value">${cert.attendance || 0} ${lang === 'en' ? 'days' : 'ÙŠÙˆÙ…'}</span>
          </div>
          <div class="info-row">
            <span class="info-label">${labels.absence}</span>
            <span class="info-value">${cert.absence || 0} ${lang === 'en' ? 'days' : 'ÙŠÙˆÙ…'}</span>
          </div>
        </div>
        <div style="margin-top: 25px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; border-radius: 8px; text-align: center;">
          <p style="font-size: 0.9rem; margin-bottom: 5px;">${labels.resultLabel}</p>
          <h2 style="font-size: 2rem; margin: 0;">${getGradeLevel(cert.grades)}</h2>
        </div>
        <div class="action-buttons">
          <button class="btn btn-primary" onclick="printCertificate()">${labels.print}</button>
          <button class="btn btn-secondary" onclick="downloadCertificateImage('${cert.id}', '${cert.studentName}')">${labels.download}</button>
        </div>
      </div>
    </div>
    `;
  }).join('');
  
  showMsg('âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
}

function getGradeColor(grade){
  const gradeValue = parseInt(grade);
  if(gradeValue >= 90) return 'grade-excellent';
  if(gradeValue >= 80) return 'grade-very-good';
  if(gradeValue >= 70) return 'grade-good';
  return 'grade-acceptable';
}

function generateGradesRows(grades){
  const subjectsAr = ['Ø§Ù„Ù‚Ø±Ø¢Ù†', 'Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©', 'Ø§Ù„Ø¹Ø±Ø¨ÙŠ', 'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª', 'Ø§Ù„Ø¹Ù„ÙˆÙ…', 'Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ', 'Ø§Ù„Ù†ÙˆØ±Ø§Ù†ÙŠÙ‡'];
  const subjectsEn = ['Quran', 'Islamic Studies', 'Arabic', 'Mathematics', 'Science', 'English', 'Nuraniyah'];
  
  // default to Arabic if lang not provided
  const lang = arguments.length > 1 ? arguments[1] : 'ar';
  return grades.map((g, i) => {
    const name = lang === 'en' ? (subjectsEn[i] || 'Subject') : (subjectsAr[i] || 'Ù…Ø§Ø¯Ø©');
    const first = g.first || 0;
    const second = g.second || 0;
    const total = first + second;
    const totalColor = getGradeColor(total);
    return `
    <tr>
      <td class="subject-name">${name}</td>
      <td>${first}</td>
      <td>${second}</td>
      <td><span class="grade-cell ${totalColor}" style="font-weight: 700;">${total}</span></td>
    </tr>
  `}).join('');
}

function calculateTotal(grades){
  return grades.reduce((sum, g) => sum + (g.first || 0) + (g.second || 0), 0);
}

function getGradeLevel(grades){
  const total = calculateTotal(grades);
  const average = total / (grades.length * 100) * 100;
  
  if(average >= 90) return 'Ù…Ù…ØªØ§Ø² ğŸŒŸ';
  if(average >= 80) return 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹ â­';
  if(average >= 70) return 'Ø¬ÙŠØ¯ âœ“';
  return 'Ù…Ù‚Ø¨ÙˆÙ„';
}

function printCertificate(){
  window.print();
}

function downloadCertificateImage(certId, studentName){
  try {
    console.log('Ø´Ø±ÙˆØ¹ Ø§Ù„ØªÙ†Ø²ÙŠÙ„ Ù„Ù„Ø´Ù‡Ø§Ø¯Ø©:', certId);
    showMsg('â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„ØµÙˆØ±Ø©...', 'info');
    
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ù…Ù† localStorage - Ø¬Ø±Ø¨ Ø§Ù„Ø£ÙˆÙ„Ù‰ Ø¨Ø§Ù„ØµÙˆØ±
    let cert = null;
    
    // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØµÙˆØ± Ø£ÙˆÙ„Ø§Ù‹
    const withImages = JSON.parse(localStorage.getItem('certificates_with_images') || '[]');
    cert = withImages.find(c => c.id === certId);
    
    // Ø¥Ø°Ø§ Ù„Ù… ØªØ¬Ø¯ØŒ Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    if(!cert) {
      const certs = JSON.parse(localStorage.getItem('certificates') || '[]');
      cert = certs.find(c => c.id === certId);
    }
    
    console.log('Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„Ù…Ø¹Ø«ÙˆØ± Ø¹Ù„ÙŠÙ‡Ø§:', cert ? 'Ù†Ø¹Ù…' : 'Ù„Ø§');
    
    if(!cert) {
      showMsg('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©', 'error');
      return;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ localStorage
    if(cert.image && cert.image.length > 0) {
      console.log('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø©:', cert.image.length);
      try {
        // ØªØ­ÙˆÙŠÙ„ base64 Ø¥Ù„Ù‰ blob
        const base64String = cert.image.includes(',') ? cert.image.split(',')[1] : cert.image;
        const bstr = atob(base64String);
        let n = bstr.length;
        const u8arr = new Uint8Array(n);
        while(n--) { u8arr[n] = bstr.charCodeAt(n); }
        const blob = new Blob([u8arr], { type: 'image/png' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `${studentName || 'certificate'}_${certId}.png`;
        document.body.appendChild(link);
        setTimeout(() => {
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
          showMsg('âœ… ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }, 100);
      } catch (conversionError) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©:', conversionError);
        showMsg('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©', 'error');
      }
      return;
    }

    // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø© Ù…Ø®Ø²Ù†Ø©ØŒ Ø­Ø§ÙˆÙ„ Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ ÙˆØ­ÙØ¸Ù‡
    const certElement = document.querySelector(`[data-cert-id="${certId}"]`);
    if(!certElement) {
      showMsg('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù†ØµØ± Ø´Ù‡Ø§Ø¯Ø© Ù…Ø±Ø¦ÙŠ Ù„Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø©', 'error');
      return;
    }

    if(typeof html2canvas === 'undefined'){
      showMsg('âš ï¸ Ù…ÙƒØªØ¨Ø© html2canvas ØºÙŠØ± Ù…Ø­Ù…Ù‘Ù„Ø© - Ø³ÙŠØªÙ… ÙØªØ­ Ø§Ù„Ù…Ø­Ø±Ø± Ù„Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©', 'error');
      return;
    }

    // Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„Ø¹Ù†ØµØ± ÙˆØªØ­ÙˆÙŠÙ„Ù‡ Ø¥Ù„Ù‰ ØµÙˆØ±Ø© ÙˆØ­ÙØ¸Ù‡Ø§
    html2canvas(certElement, { scale: 2, useCORS: true, backgroundColor: '#ffffff' })
      .then(canvas => {
        try {
          const dataUrl = canvas.toDataURL('image/png');
          // Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ù…Ø®Ø²Ù† Ø§Ù„ØµÙˆØ±
          let withImages = [];
          try { withImages = JSON.parse(localStorage.getItem('certificates_with_images') || '[]'); } catch(e){ withImages = []; }
          const existingIndex = withImages.findIndex(c => c.id === certId);
          const entry = { ...(cert || {}), image: dataUrl, id: certId };
          if(existingIndex !== -1) withImages[existingIndex] = entry; else withImages.push(entry);
          localStorage.setItem('certificates_with_images', JSON.stringify(withImages));

          // Ø«Ù… ØªÙ†Ø²ÙŠÙ„Ù‡Ø§ Ù…Ø¨Ø§Ø´Ø±Ø©
          const link2 = document.createElement('a');
          link2.href = dataUrl;
          link2.download = `${studentName || 'certificate'}_${certId}.png`;
          document.body.appendChild(link2);
          setTimeout(() => { link2.click(); document.body.removeChild(link2); showMsg('âœ… ØªÙ… Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø© ÙˆØ­ÙØ¸Ù‡Ø§ ÙˆØªÙ†Ø²ÙŠÙ„Ù‡Ø§', 'success'); }, 100);
        } catch(e){ console.error('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©:', e); showMsg('âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©', 'error'); }
      })
      .catch(err => { console.error('Ø®Ø·Ø£ ÙÙŠ html2canvas:', err); showMsg('âŒ ÙØ´Ù„ Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø©', 'error'); });
      
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ†Ø²ÙŠÙ„:', error);
    showMsg('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©', 'error');
  }
}

// Ø­Ø¯Ø« Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
window.addEventListener('load', () => {
  document.getElementById('emptyState').style.display = 'block';
});
</script>

<!-- Ù…ÙƒØªØ¨Ø© Ù„ØªØ­ÙˆÙŠÙ„ Ø¹Ù†Ø§ØµØ± HTML Ø¥Ù„Ù‰ ØµÙˆØ± (Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø¹Ù†Ø¯ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ ØµÙˆØ±Ø© Ù…Ø­ÙÙˆØ¸Ø©) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

</body>
</html>
